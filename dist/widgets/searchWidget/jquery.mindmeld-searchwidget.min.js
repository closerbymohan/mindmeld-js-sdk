!function(e,t,n){e.widget("mindmeld.mmautocomplete",e.ui.autocomplete,{_truncateText:function(e,t,i){if(i===n&&(i="..."),e.length<=t||e.length-i.length<=t)return e;var s=e.indexOf("<em>");return e=-1!==s?this._getTruncatedEmString(e,t-i.length)+i:String(e).substring(0,t-i.length)+i},_getTruncatedEmString:function(e,t){var n=/<em>\S+<\/em>/,i=n.exec(e),s=i.index,o=i[0],a=o.length,r=t-a,c=Math.max(0,s-r),u=e.substr(c,Math.min(r,s)),l=u+o;if(l.length<t){r=t-l.length;var d=s+a,m=e.indexOf("<em>",d);l+=-1!==m?e.substr(d,Math.min(r,m-d)):e.substr(d,r)}return l},_renderItem:function(t,n){var i=null;if(n.noResult)i=e("<li>",{"class":"noResultItem"}).append(e("<a>").append(e("<div>",{"class":"noResultContainer"}).append(e("<span>",{"class":"noResultText"}).html("No results"))));else{var s=n.document.snippet||n.document.description||n.document.text,o=null;n.document.image&&(o=n.document.image.thumburl||n.document.image.url||null);var a;a=this.options.images&&o?this._getItemContentWithImage(o,s):this._getItemContentWithoutImage(s),i=e("<li>",{"class":"docListItem"}).append(e("<a>",{href:n.document.originurl}).append(e("<div>",{"class":"docListWrapper"}).append(e('<span class="docTitle">'+n.document.title+"</span>")).append(a)))}return i.appendTo(t)},_getItemContentWithImage:function(t,n){return n=this._truncateText(n,75),e("<div>",{"class":"docContentWithImage"}).append(e("<div>",{"class":"docImg"}).append(e("<img>",{"class":"docImgFile",src:t}))).append(e("<div>",{"class":"docDetails"}).append(e('<p class="textBlurb">'+n+"</p>")))},_getItemContentWithoutImage:function(t){return t=this._truncateText(t,130),e("<div>",{"class":"docContentWithoutImage"}).append(e('<p class="textBlurb">'+t+"</p>"))}}),e.widget("mindmeld.searchwidget",{options:{images:!1,onMMSearchInitialized:function(){},onMMSearchError:function(){}},_create:function(){e('<div id="mm-results" style="position: absolute;"></div>').appendTo("body"),this.queryCache={},this.numQueriesCached=0,this._initMM(),this._initialized=!1},initialized:function(){return this._initialized},_initMM:function(){function e(){t.getToken({anonymous:{userid:"MMSearchWidgetUserID",name:"MMSearchWidgetUser",domain:window.location.hostname}},function(){i._getOrSetSession()},function(){i.options.onMMSearchError("Supplied token is invalid")})}var n=this.options.appid||t.appid;if(!this._validateString(n,40))return void this.options.onMMSearchError("Please supply a valid appid");var i=this,s={appid:n,onInit:e};t.init(s)},_getOrSetSession:function(){function e(){function e(e){t.setActiveSessionID(e.data.sessionid,n,i)}var s=t.activeUser.sessions.json();if(s.length>0)t.setActiveSessionID(s[0].sessionid,n,i);else{var o={name:"search session",privacymode:"inviteonly"};t.activeUser.sessions.post(o,e,i)}}function n(){s._onInitialized()}function i(){s.options.onMMSearchError("Error fetching and setting session")}var s=this;t.activeUser.sessions.get(null,e,i)},_onInitialized:function(){this._initialized=!0,this.options.onMMSearchInitialized();var t=this;this.element.mmautocomplete({minLength:2,delay:100,source:function(n,i){t.queryDocuments(n.term,function(t){var n=[];0===t.length?n.push({noResult:!0}):n=e.map(t,function(e){return{label:e.title,document:e}}),i(n)},function(e){t.onMMSearchError(e),i([])})},appendTo:"#mm-results",open:function(){var n=t.element.offset(),i=t.element.outerHeight(),s=t.element.outerWidth(),o=10,a=s-o,r=n.top+i-1,c=n.left+o/2;e("#mm-results > ul.ui-autocomplete").css({width:a+"px"}).offset({top:r,left:c})},select:function(e,n){return n.item.document&&(e.ctrlKey||e.metaKey||(window.location.href=n.item.document.originurl),t.element.val("")),!1},focus:function(t,n){if(n.item.document){var i=e(this).data("mindmeldMmautocomplete").menu.element,s=i.find("li");s.each(function(){e(this).removeClass("focused")});var o=i.find("li:has(a.ui-state-focus)");o.addClass("focused")}return!1},images:t.options.images})},_stripEmTags:function(e){return e=e.replace(/<em>/g,""),e=e.replace(/<\/em>/g,"")},queryDocuments:function(e,n,i){var s=this;if(this.queryCache[e])n(this.queryCache[e]);else if(this._initialized){var o=this._getWildcardQuery(e),a={query:o,highlight:1,limit:5};a["document-ranking-factors"]={relevance:1,recency:0,popularity:0,proximity:0,customrank1:0,customrank2:0,customrank3:0},t.activeSession.documents.get(a,function(){var i=t.activeSession.documents.json();s.numQueriesCached++,s.queryCache[e]=i,n(i)},function(e){i("Error fetching documents: "+e.message)}),this._cleanQueryCache()}else i("Cannot query documents, MM search widget not initialized")},_getWildcardQuery:function(t){var n=t.split(" "),i="";e.each(n,function(e,t){""!==t&&(i+=t+"* ")});var s="title:("+i+") description:("+i+") text:("+i+")";return s},_cleanQueryCache:function(){if(this.numQueriesCached>100){for(var e=Object.keys(this.queryCache),t=0;50>t;t++){var n=e[t];delete this.queryCache[e[t]],console.log("removing cached query: "+n)}this.numQueriesCached=Object.keys(this.queryCache).length}},_validateString:function(e,t){return e===n?!1:t!==n&&e.length!==t?!1:!0}})}($,MM);