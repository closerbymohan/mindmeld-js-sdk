!function(e,t,i){e.widget("mindmeld.mmautocomplete",e.ui.autocomplete,{_truncateText:function(e,t,n){if(n===i&&(n="..."),e.length<=t||e.length-n.length<=t)return e;var o=e.indexOf("<em>");return e=-1!==o?this._getTruncatedEmString(e,t-n.length)+n:String(e).substring(0,t-n.length)+n},_getTruncatedEmString:function(e,t){var i=/<em>\S+<\/em>/,n=i.exec(e),o=n.index,s=n[0],a=s.length,r=t-a,c=Math.max(0,o-r),u=e.substr(c,Math.min(r,o)),l=u+s;if(l.length<t){r=t-l.length;var d=o+a,m=e.indexOf("<em>",d);l+=-1!==m?e.substr(d,Math.min(r,m-d)):e.substr(d,r)}return l},_renderItem:function(t,i){var n=null;if(i.noResult)n=e("<li>",{"class":"noResultItem"}).append(e("<a>").append(e("<div>",{"class":"noResultContainer"}).append(e("<span>",{"class":"noResultText"}).html("No results"))));else{var o=i.document.snippet||i.document.description||i.document.text,s=null;i.document.image&&(s=i.document.image.thumburl||i.document.image.url||null);var a;a=this.options.images&&s?this._getItemContentWithImage(s,o):this._getItemContentWithoutImage(o),n=e("<li>",{"class":"docListItem"}).append(e("<a>",{href:i.document.originurl}).append(e("<div>",{"class":"docListWrapper"}).append(e('<span class="docTitle">'+i.document.title+"</span>")).append(a)))}return n.appendTo(t)},_getItemContentWithImage:function(t,i){return i=this._truncateText(i,75),e("<div>",{"class":"docContentWithImage"}).append(e("<div>",{"class":"docImg"}).append(e("<img>",{"class":"docImgFile",src:t}))).append(e("<div>",{"class":"docDetails"}).append(e('<p class="textBlurb">'+i+"</p>")))},_getItemContentWithoutImage:function(t){return t=this._truncateText(t,130),e("<div>",{"class":"docContentWithoutImage"}).append(e('<p class="textBlurb">'+t+"</p>"))}}),e.widget("mindmeld.searchwidget",{options:{images:!1,voiceNavigatorEnabled:!1,onMMSearchInitialized:function(){},onMMSearchError:function(){}},_create:function(){e('<div id="mm-results" style="position: absolute;"></div>').appendTo("body"),this.queryCache={},this.numQueriesCached=0,this._initMM(),this._initialized=!1},initialized:function(){return this._initialized},_setWidgetOptions:function(){for(var e in t.widgets.config.search)this.options[e]=t.widgets.config.search[e]},_validateConfig:function(){return!e.isEmptyObject(t.widgets)&&!e.isEmptyObject(t.widgets.config)},_initMM:function(){function e(){t.getToken({anonymous:{userid:"MMSearchWidgetUserID",name:"MMSearchWidgetUser",domain:window.location.hostname}},function(){o._getOrSetSession()},function(){o.options.onMMSearchError("Supplied token is invalid")})}if(this._validateConfig()){this._setWidgetOptions();var n=t.widgets.config.appID;if(!this._validateString(n,40))return void this.options.onMMSearchError("Please supply a valid appid");var o=this,s={appid:n,onInit:e};t.widgets.config.cleanUrl!==i&&(s.cleanUrl=t.widgets.config.cleanUrl),t.widgets.config.fayeClientUrl!==i&&(s.fayeClientUrl=t.widgets.config.fayeClientUrl),t.init(s)}else console.log("Invalid search widget config")},_getOrSetSession:function(){function e(){function e(e){t.setActiveSessionID(e.data.sessionid,i,n)}var o=t.activeUser.sessions.json();if(o.length>0)t.setActiveSessionID(o[0].sessionid,i,n);else{var s={name:"search session",privacymode:"inviteonly"};t.activeUser.sessions.post(s,e,n)}}function i(){o._onInitialized()}function n(){o.options.onMMSearchError("Error fetching and setting session")}var o=this;t.activeUser.sessions.get(null,e,n)},_onInitialized:function(){this._initialized=!0,this.options.onMMSearchInitialized();var t=this;this.element.mmautocomplete({minLength:2,delay:100,source:function(i,n){t.queryDocuments(i.term,function(t){var i=[];0===t.length?i.push({noResult:!0}):i=e.map(t,function(e){return{label:e.title,document:e}}),n(i)},function(e){t.onMMSearchError(e),n([])})},appendTo:"#mm-results",open:function(){var i=t.element.offset(),n=t.element.outerHeight(),o=t.element.outerWidth(),s=10,a=o-s,r=i.top+n-1,c=i.left+s/2;e("#mm-results > ul.ui-autocomplete").css({width:a+"px"}).offset({top:r,left:c})},select:function(e,i){return i.item.document&&(e.ctrlKey||e.metaKey||(window.location.href=i.item.document.originurl),t.element.val("")),!1},focus:function(t,i){if(i.item.document){var n=e(this).data("mindmeldMmautocomplete").menu.element,o=n.find("li");o.each(function(){e(this).removeClass("focused")});var s=n.find("li:has(a.ui-state-focus)");s.addClass("focused")}return!1},images:t.options.images}),this.options.voiceNavigatorEnabled&&this.element.keypress(function(e){if(13===e.which){var i=t.element.val();t._openVoiceNavigator(i)}})},_openVoiceNavigator:function(e){t.voiceNavigator!==i?t.voiceNavigator.showModal(e):t.loader.widgetLoaded("voice",function(){t.voiceNavigator.showModal(e)})},_stripEmTags:function(e){return e=e.replace(/<em>/g,""),e=e.replace(/<\/em>/g,"")},queryDocuments:function(e,i,n){var o=this;if(this.queryCache[e])i(this.queryCache[e]);else if(this._initialized){var s=this._getWildcardQuery(e),a={query:s,highlight:1,limit:5};a["document-ranking-factors"]={relevance:1,recency:0,popularity:0,proximity:0,customrank1:0,customrank2:0,customrank3:0},t.activeSession.documents.get(a,function(){var n=t.activeSession.documents.json();o.numQueriesCached++,o.queryCache[e]=n,i(n)},function(e){n("Error fetching documents: "+e.message)}),this._cleanQueryCache()}else n("Cannot query documents, MM search widget not initialized")},_getWildcardQuery:function(t){var i=t.split(" "),n="";if(i.length>0&&" "!==t.slice(-1)){var o=i.length-1;i[o]+="*",e.each(i,function(e,t){n+=t+" "})}else n=t;return n},_cleanQueryCache:function(){if(this.numQueriesCached>100){for(var e=Object.keys(this.queryCache),t=0;50>t;t++){var i=e[t];delete this.queryCache[e[t]],console.log("removing cached query: "+i)}this.numQueriesCached=Object.keys(this.queryCache).length}},_validateString:function(e,t){return e===i?!1:t!==i&&e.length!==t?!1:!0}})}($,MM);