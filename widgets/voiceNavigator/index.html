<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]> ><! <![endif]-->
<html class='no-js' lang='en'>
  <!-- <![endif] -->
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>MindMeld Voice Demo</title>
    <meta content='Voice nav' name='description'>
    <meta content='width=device-width' name='viewport'>
    <link rel="stylesheet" href="./_build/widget/widget.css" type="text/css">

    <style type="text/css">
      body {
        background-image: url(./img/rottentomatoes-bg.png);
        background-size: cover;
        background-position: top center;
      }

      html, body {
        min-height: 100%; /* For bg image */
      }
    </style>
  </head>
  <body>
    <div class='main' role='main'>

      <a class='mm-voice-nav-init' href='#' id='toggle' style='position: absolute; top: 0; right: 0; color: red; padding: 5px 11px;'>Open Modal!</a>

    </div>
    <script>

      /** CHANGE THE VALUE BELOW TO CHOOSE WHICH TIER TO USE */
      var environmentKey = 'staging';
      /** CHANGE THE VALUE ABOVE TO CHOOSE WHICH TIER TO USE */

      var environmentVariables = {
        dev: {
          appID: '6501c34aa68d1cc78229e5ea31a20d2f5b02725c', // Suvda's RT Apr 29 in dev
          cleanUrl: 'https://api-west-dev-d.expectlabs.com/',
          fayeClientUrl: 'https://push-west-dev-d.expectlabs.com:443/faye'
        },
        staging: {
          appID: 'c17c83236fa87f37d7930b6d69ea69c5d2d5eed0', // Simon's 'RT Apr 29' on staging
          cleanUrl: 'https://api-west-dev-e.expectlabs.com/',
          fayeClientUrl: 'https://push-west-dev-e.expectlabs.com:443/faye'
        }
      };
      if (typeof environmentVariables[environmentKey] === 'undefined') {
        environmentKey = 'staging';
      }

      // Example snippet to specify voice nav options
      var MM = window.MM || {};
      MM.voiceNavigator = MM.voiceNavigator || {};
      MM.voiceNavigator.options = environmentVariables[environmentKey];

      MM.voiceNavigator.options.cardStyle = rottenTomatoesCard;

      function rottenTomatoesCard(doc) {
        var html = '';
        var title = '<h2>' + doc.title + '</h2>';
        html += title;

        var description;
        if (typeof doc.description !== 'undefined') {
          description = doc.description.substr(0, 150) + (doc.description.length > 150 ? "&hellip;" : "");
        } else {
          description = "No description";
        }
        html += '<p>' + description + '</p>';

        var imageURL = false;
        if (typeof doc.image !== 'undefined') {
          if (typeof doc.image.url !== 'undefined') {
            imageURL = doc.image.url;
          } else if (typeof doc.image.thumburl !== 'undefined') {
            imageURL = doc.image.thumburl;
          }
        }
        if (imageURL) {
          html += '<p class="image notloaded"><img src="' + imageURL + '"></p>';
        }

        function getElementForKey(key, alignment) {
          var value = getFormattedValueForKey(key);

          var element = '<p class="align-' + alignment;
          if ((value === '')) { // empty value, use placeholder instead
            element += ' placeholder">' + getPlaceholderForKey(key);
          } else {
            element += '">'; // close initial p tag

            if (key === 'rating') {
              // add appropriate icon for rating
              var rating = parseInt(doc[key]);

              var icon = '<span class="rt-icon tiny ';
              icon += rating < 60 ? 'rotten' : 'fresh';
              icon += '"></span>';
              element += icon;


              var rating = '<span class="rt-rating">' + value + '</span>';
              element += rating;

            } else {
              // just add the text for others
              element += value;
            }
          }
          element += '</p>'; // close element

          return element;
        }

        function getFormattedValueForKey(key) {
          var value = doc[key];
          if (typeof value === 'undefined') {
            return '';
          }
          if (key === 'pubdate') {
            var date = new Date(value * 1000);
            return (date.getMonth() + 1) + '/' + date.getDay() + '/' + date.getFullYear();
          } else if (key === 'rating') {
            return value + '%';
          } else if (key === 'reviewcount') {
            var scales = ['', 'k', 'M'];
            var scale = scales.shift();
            while (value > 1000 && scales.length > 0) {
              scale = scales.shift(); // remove next scale
              value = parseInt(value) / 1000;
            }

            return '(' + Math.floor(value) + scale + ' reviews)';
          }
          return value;
        }

        function getPlaceholderForKey(key) {
          if (key === 'pubdate') {
            return 'No release date';
          } else if (key === 'genre') {
            return 'No genre';
          } else if (key === 'rating') {
            return 'No rating';
          } else if (key === 'reviewcount') {
            return 'No reviews';
          }
        }

        var rows = [{
          left: 'genre',
          right: 'pubdate'
        }, {
          left: 'rating',
          right: 'reviewcount'
        }];

        for (var i = 0, l = rows.length; i < l; i++) {
          var row = '<div class="metadata-row">';

          for (var alignment in rows[i]) {
            var elem = getElementForKey(rows[i][alignment], alignment);

            row += elem;
          }

          row += '<p class="clear-fix"></p>';
          row += '</div>';

          html += row;
        }

        return html;
      }
    </script>
    <script src="./_build/widget/widget.js"></script>
    <script>
        // Auto open modal
//        window.MM.voiceNavigator.showModal();
    </script>
  </body>
</html>

