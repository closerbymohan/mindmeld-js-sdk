!function(a,b,c){a.widget("mindmeld.mmautocomplete",a.ui.autocomplete,{_truncateText:function(a,b,d){if(d===c&&(d="..."),a.length<=b||a.length-d.length<=b)return a;var e=a.indexOf("<em>");return a=-1!==e?this._getTruncatedEmString(a,b-d.length)+d:String(a).substring(0,b-d.length)+d},_getTruncatedEmString:function(a,b){var c=/<em>\S+<\/em>/,d=c.exec(a),e=d.index,f=d[0],g=f.length,h=b-g,i=Math.max(0,e-h),j=a.substr(i,Math.min(h,e)),k=j+f;if(k.length<b){h=b-k.length;var l=e+g,m=a.indexOf("<em>",l);k+=-1!==m?a.substr(l,Math.min(h,m-l)):a.substr(l,h)}return k},_renderItem:function(b,c){var d=null;if(c.noResult)d=a("<li>",{"class":"noResultItem"}).append(a("<a>").append(a("<div>",{"class":"noResultContainer"}).append(a("<span>",{"class":"noResultText"}).html("No results"))));else{var e=c.document.snippet||c.document.description||c.document.text,f=null;c.document.image&&(f=c.document.image.thumburl||c.document.image.url||null);var g;g=this.options.images&&f?this._getItemContentWithImage(f,e):this._getItemContentWithoutImage(e),d=a("<li>",{"class":"docListItem"}).append(a("<a>",{href:c.document.originurl}).append(a("<div>",{"class":"docListWrapper"}).append(a('<span class="docTitle">'+c.document.title+"</span>")).append(g)))}return d.appendTo(b)},_getItemContentWithImage:function(b,c){return c=this._truncateText(c,75),a("<div>",{"class":"docContentWithImage"}).append(a("<div>",{"class":"docImg"}).append(a("<img>",{"class":"docImgFile",src:b}))).append(a("<div>",{"class":"docDetails"}).append(a('<p class="textBlurb">'+c+"</p>")))},_getItemContentWithoutImage:function(b){return b=this._truncateText(b,130),a("<div>",{"class":"docContentWithoutImage"}).append(a('<p class="textBlurb">'+b+"</p>"))}}),a.widget("mindmeld.searchwidget",{options:{images:!1,onMMSearchInitialized:function(){},onMMSearchError:function(){}},_create:function(){a('<div id="mm-results" style="position: absolute;"></div>').appendTo("body"),this.queryCache={},this.numQueriesCached=0,this._initMM(),this._initialized=!1},initialized:function(){return this._initialized},_initMM:function(){function a(){function a(){function a(){c._getOrSetSession()}function d(){c.options.onMMSearchError("Supplied userid is invalid")}b.setActiveUserID(c.options.userid,a,d)}function d(){c.options.onMMSearchError("Supplied token is invalid")}b.setToken(c.options.token,a,d)}if(!this._validateString(this.options.appid,40))return void this.options.onMMSearchError("Please supply a valid appid");if(!this._validateString(this.options.token,40))return void this.options.onMMSearchError("Please supply a valid token");if(!this._validateString(this.options.userid))return void this.options.onMMSearchError("Please supply a valid userid");var c=this,d={appid:this.options.appid,onInit:a};b.init(d)},_getOrSetSession:function(){function a(){function a(a){b.setActiveSessionID(a.data.sessionid,c,d)}var e=b.activeUser.sessions.json();if(e.length>0)b.setActiveSessionID(e[0].sessionid,c,d);else{var f={name:"search session",privacymode:"inviteonly"};b.activeUser.sessions.post(f,a,d)}}function c(){e._onInitialized()}function d(){e.options.onMMSearchError("Error fetching and setting session")}var e=this;b.activeUser.sessions.get(null,a,d)},_onInitialized:function(){this._initialized=!0,this.options.onMMSearchInitialized();var b=this;this.element.mmautocomplete({minLength:2,delay:100,source:function(c,d){b.queryDocuments(c.term,function(b){var c=[];0===b.length?c.push({noResult:!0}):c=a.map(b,function(a){return{label:a.title,document:a}}),d(c)},function(a){b.onMMSearchError(a),d([])})},appendTo:"#mm-results",open:function(){var c=b.element.offset(),d=b.element.outerHeight(),e=b.element.outerWidth(),f=10,g=e-f,h=c.top+d-1,i=c.left+f/2;a("#mm-results > ul.ui-autocomplete").css({width:g+"px"}).offset({top:h,left:i})},select:function(a,c){if(c.item.document){a.ctrlKey||a.metaKey||(window.location.href=c.item.document.originurl);var d=b._stripEmTags(c.item.value);b.element.val(d)}return!1},focus:function(b,c){if(c.item.document){var d=a(this).data("mindmeldMmautocomplete").menu.element,e=d.find("li");e.each(function(){a(this).removeClass("focused")});var f=d.find("li:has(a.ui-state-focus)");f.addClass("focused")}return!1},images:b.options.images})},_stripEmTags:function(a){return a=a.replace(/<em>/g,""),a=a.replace(/<\/em>/g,"")},queryDocuments:function(a,c,d){var e=this;if(this.queryCache[a])c(this.queryCache[a]);else if(this._initialized){var f=this._getWildcardQuery(a),g={query:f,highlight:1,limit:5};g["document-ranking-factors"]={relevance:1,recency:0,popularity:0,proximity:0,customrank1:0,customrank2:0,customrank3:0},b.activeSession.documents.get(g,function(){var d=b.activeSession.documents.json();e.numQueriesCached++,e.queryCache[a]=d,c(d)},function(a){d("Error fetching documents: "+a.message)}),this._cleanQueryCache()}else d("Cannot query documents, MM search widget not initialized")},_getWildcardQuery:function(b){var c=b.split(" "),d="";a.each(c,function(a,b){""!==b&&(d+=b+"* ")});var e="title:("+d+") description:("+d+") text:("+d+")";return e},_cleanQueryCache:function(){if(this.numQueriesCached>100){for(var a=Object.keys(this.queryCache),b=0;50>b;b++){var c=a[b];delete this.queryCache[a[b]],console.log("removing cached query: "+c)}this.numQueriesCached=Object.keys(this.queryCache).length}},_validateString:function(a,b){return a===c?!1:b!==c&&a.length!==b?!1:!0}})}($,MM);