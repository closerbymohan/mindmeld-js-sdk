!function(e,t,i){e.widget("mindmeld.mmautocomplete",e.ui.autocomplete,{_truncateText:function(e,t,n){if(n===i&&(n="..."),e.length<=t||e.length-n.length<=t)return e;var s=e.indexOf("<em>");return e=-1!==s?this._getTruncatedEmString(e,t-n.length)+n:String(e).substring(0,t-n.length)+n},_getTruncatedEmString:function(e,t){var i=/<em>\S+<\/em>/,n=i.exec(e),s=n.index,o=n[0],a=o.length,r=t-a,c=Math.max(0,s-r),u=e.substr(c,Math.min(r,s)),l=u+o;if(l.length<t){r=t-l.length;var d=s+a,m=e.indexOf("<em>",d);l+=-1!==m?e.substr(d,Math.min(r,m-d)):e.substr(d,r)}return l},_renderItem:function(t,i){var n=null;if(i.noResult)n=e("<li>",{"class":"noResultItem"}).append(e("<a>").append(e("<div>",{"class":"noResultContainer"}).append(e("<span>",{"class":"noResultText"}).html("No results"))));else{var s=i.document.snippet||i.document.description||i.document.text,o=null;i.document.image&&(o=i.document.image.thumburl||i.document.image.url||null);var a;a=this.options.images&&o?this._getItemContentWithImage(o,s):this._getItemContentWithoutImage(s),n=e("<li>",{"class":"docListItem"}).append(e("<a>",{href:i.document.originurl}).append(e("<div>",{"class":"docListWrapper"}).append(e('<span class="docTitle">'+i.document.title+"</span>")).append(a)))}return n.appendTo(t)},_getItemContentWithImage:function(t,i){return i=this._truncateText(i,75),e("<div>",{"class":"docContentWithImage"}).append(e("<div>",{"class":"docImg"}).append(e("<img>",{"class":"docImgFile",src:t}))).append(e("<div>",{"class":"docDetails"}).append(e('<p class="textBlurb">'+i+"</p>")))},_getItemContentWithoutImage:function(t){return t=this._truncateText(t,130),e("<div>",{"class":"docContentWithoutImage"}).append(e('<p class="textBlurb">'+t+"</p>"))}}),e.widget("mindmeld.searchwidget",{options:{images:!1,voiceNavigatorEnabled:!1,onMMSearchInitialized:function(){},onMMSearchError:function(){}},_create:function(){e('<div id="mm-results" style="position: absolute;"></div>').appendTo("body"),this.queryCache={},this.numQueriesCached=0,this._initMM(),this._initialized=!1},initialized:function(){return this._initialized},_setWidgetOptions:function(){for(var e in t.widgets.config.search)this.options[e]=t.widgets.config.search[e]},_validateConfig:function(){return!e.isEmptyObject(t.widgets)&&!e.isEmptyObject(t.widgets.config)},_initMM:function(){function e(){t.getToken({anonymous:{userid:"MMSearchWidgetUserID",name:"MMSearchWidgetUser",domain:window.location.hostname}},function(){n._getOrSetSession()},function(){n.options.onMMSearchError("Supplied token is invalid")})}if(this._validateConfig()){this._setWidgetOptions();var i=t.widgets.config.appID;if(!this._validateString(i,40))return void this.options.onMMSearchError("Please supply a valid appid");var n=this,s={appid:i,onInit:e};"undefined"!=typeof n.options.cleanUrl&&(s.cleanUrl=n.options.cleanUrl),"undefined"!=typeof n.options.fayeClientUrl&&(s.fayeClientUrl=n.options.fayeClientUrl),t.init(s)}else console.log("Invalid search widget config")},_getOrSetSession:function(){function e(){function e(e){t.setActiveSessionID(e.data.sessionid,i,n)}var s=t.activeUser.sessions.json();if(s.length>0)t.setActiveSessionID(s[0].sessionid,i,n);else{var o={name:"search session",privacymode:"inviteonly"};t.activeUser.sessions.post(o,e,n)}}function i(){s._onInitialized()}function n(){s.options.onMMSearchError("Error fetching and setting session")}var s=this;t.activeUser.sessions.get(null,e,n)},_onInitialized:function(){this._initialized=!0,this.options.onMMSearchInitialized();var i=this;this.element.mmautocomplete({minLength:2,delay:100,source:function(t,n){i.queryDocuments(t.term,function(t){var i=[];0===t.length?i.push({noResult:!0}):i=e.map(t,function(e){return{label:e.title,document:e}}),n(i)},function(e){i.onMMSearchError(e),n([])})},appendTo:"#mm-results",open:function(){var t=i.element.offset(),n=i.element.outerHeight(),s=i.element.outerWidth(),o=10,a=s-o,r=t.top+n-1,c=t.left+o/2;e("#mm-results > ul.ui-autocomplete").css({width:a+"px"}).offset({top:r,left:c})},select:function(e,t){return t.item.document&&(e.ctrlKey||e.metaKey||(window.location.href=t.item.document.originurl),i.element.val("")),!1},focus:function(t,i){if(i.item.document){var n=e(this).data("mindmeldMmautocomplete").menu.element,s=n.find("li");s.each(function(){e(this).removeClass("focused")});var o=n.find("li:has(a.ui-state-focus)");o.addClass("focused")}return!1},images:i.options.images}),this.options.voiceNavigatorEnabled&&this.element.keypress(function(e){13===e.which&&t.voiceNavigator&&t.voiceNavigator.showModal()})},_stripEmTags:function(e){return e=e.replace(/<em>/g,""),e=e.replace(/<\/em>/g,"")},queryDocuments:function(e,i,n){var s=this;if(this.queryCache[e])i(this.queryCache[e]);else if(this._initialized){var o=this._getWildcardQuery(e),a={query:o,highlight:1,limit:5};a["document-ranking-factors"]={relevance:1,recency:0,popularity:0,proximity:0,customrank1:0,customrank2:0,customrank3:0},t.activeSession.documents.get(a,function(){var n=t.activeSession.documents.json();s.numQueriesCached++,s.queryCache[e]=n,i(n)},function(e){n("Error fetching documents: "+e.message)}),this._cleanQueryCache()}else n("Cannot query documents, MM search widget not initialized")},_getWildcardQuery:function(t){var i=t.split(" "),n="";e.each(i,function(e,t){""!==t&&(n+=t+"* ")});var s="title:("+n+") description:("+n+") text:("+n+")";return s},_cleanQueryCache:function(){if(this.numQueriesCached>100){for(var e=Object.keys(this.queryCache),t=0;50>t;t++){var i=e[t];delete this.queryCache[e[t]],console.log("removing cached query: "+i)}this.numQueriesCached=Object.keys(this.queryCache).length}},_validateString:function(e,t){return e===i?!1:t!==i&&e.length!==t?!1:!0}})}($,MM);